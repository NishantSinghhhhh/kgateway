apiVersion: v1
kind: ConfigMap
metadata:
  name: ratelimit-config
  namespace: kgateway-system
data:
  config.yaml: |
    domain: api-gateway
    descriptors:
      - key: remote_address
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: path
        value: "/path1"
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: user_id
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: user_id
        value: user1
        rate_limit:
          unit: minute
          requests_per_unit: 1
      - key: service
        value: premium-api
        rate_limit:
          unit: minute
          requests_per_unit: 2
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: kgateway-system
spec:
  selector:
    app: ratelimit-redis
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratelimit-redis
  labels:
   app: ratelimit-redis
  namespace: kgateway-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ratelimit-redis
  template:
    metadata:
      labels:
        app: ratelimit-redis
    spec:
      containers:
      - name: redis
        image: redis:6.0.6
        resources:
          limits:
            cpu: 1500m
            memory: 512Mi
          requests:
            cpu: 200m
            memory: 256Mi
---
apiVersion: v1
kind: Service
metadata:
  name: ratelimit-demo-ratelimit
  labels:
   app: ratelimit-demo-rl
  namespace: kgateway-system
spec:
  ports:
  - name: ratelimit-app
    port: 42080
    protocol: TCP
    targetPort: 8080
  - name: ratelimit-app-grpc
    port: 42081
    protocol: TCP
    targetPort: 8081
  selector:
    app: ratelimit-demo-rl
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratelimit-demo-rl
  namespace: kgateway-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ratelimit-demo-rl
  template:
    metadata:
      labels:
        app: ratelimit-demo-rl
    spec:
      containers:
      - name: ratelimit
        image: envoyproxy/ratelimit:3e085e5b
        command: ["/bin/ratelimit"]
        env:
        - name: RUNTIME_ROOT
          value: /data
        - name: RUNTIME_SUBDIRECTORY
          value: ratelimit
        - name: REDIS_SOCKET_TYPE
          value: "tcp"
        - name: REDIS_URL
          value: "redis:6379"
        - name: RUNTIME_WATCH_ROOT
          value: "false"
        volumeMounts:
        - name: config-volume
          mountPath: /data/ratelimit/config
        resources:
         limits:
           cpu: 1500m 
           memory: 512Mi
         requests:
           cpu: 200m
           memory: 256Mi
      volumes:
      - name: config-volume
        configMap:
          defaultMode: 420
          name: ratelimit-config